<!doctype html><html lang="ja"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>ã‚¹ãƒãƒ›ç”¨ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ„ãƒªãƒ¼</title>
<style>
:root{
  --bg:#0E1117; --card:#161B22; --ink:#E6EDF3; --muted:#9BA5B4;
  --line:#2D333B; --accent:#8A7CFB; --accent2:#35A7FF; --danger:#ff6b6b;
  --wire:#3f4b5c;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Sans","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}
header{position:sticky;top:0;z-index:30;background:linear-gradient(90deg,#141821,#141b25);border-bottom:1px solid var(--line);padding:10px 14px}
header h1{font-size:16px;margin:0 0 6px}
header .sub{font-size:12px;color:var(--muted)}
.wrap{display:flex;flex-direction:column;gap:12px;padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
.tabs{display:flex;gap:8px}
.tab{flex:1;text-align:center;padding:10px;border-radius:10px;background:#0C1016;border:1px solid #2c3440;color:#c7d0e5;font-weight:700}
.tab.active{background:var(--accent);color:#fff;border-color:transparent}
.btn{appearance:none;border:none;border-radius:10px;padding:12px 14px;color:#fff;background:var(--accent);font-weight:700;font-size:16px}
.btn.alt{background:var(--accent2)} .btn.ghost{background:transparent;border:1px solid #39414f;color:#c7d0e5}
.btn.danger{background:var(--danger)}
.row{display:flex;flex-direction:column;gap:6px;margin:8px 0}
label{font-size:12px;color:var(--muted)}
input,select,textarea{width:100%;padding:12px 10px;border-radius:10px;border:1px solid #2c3440;background:#0C1016;color:var(--ink);font-size:16px}
textarea{min-height:90px}
.hint{font-size:12px;color:var(--muted)}
.btnbar{display:flex;gap:8px;flex-wrap:wrap}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;color:var(--muted)}
.viewonly{margin:0 0 8px 0;padding:8px 10px;border-radius:10px;background:#12202e;border:1px solid #24384d;color:#cbe2ff;font-size:12px}

/* ===== ãƒ„ãƒªãƒ¼ï¼ˆè¦ªãƒ¦ãƒ‹ãƒƒãƒˆï¼å¤«å©¦/ç‰‡è¦ªã‚’ã¾ã¨ã‚ã‚‹æ¨ªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ ===== */
.tree{padding:6px}
.g{display:flex;flex-direction:column;align-items:center;gap:8px;margin:10px 0}
.node{background:linear-gradient(180deg,#1b2230,#151a26);border:1px solid #313949;border-radius:14px;padding:10px 12px;box-shadow:0 2px 8px rgba(0,0,0,.25)}
.node .n{font-weight:800;font-size:17px}
.pill,.chip{font-size:11px;border:1px solid #2c3650;background:#0f1322;border-radius:999px;padding:4px 8px;color:#b8c2dd;margin-right:6px}
.unit{display:flex;align-items:center;gap:0}
.unit .sp{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;cursor:pointer}
.unit .sp:active{opacity:.85}
.unit .sep{width:28px;height:2px;background:var(--wire);border-radius:2px}
.children{display:flex;gap:24px;align-items:flex-start;position:relative}
.children::before{content:"";position:absolute;left:0;right:0;top:-8px;height:2.5px;background:var(--wire)}
.linkDown{width:2px;height:16px;background:var(--wire)}
.childWrap{display:flex;flex-direction:column;align-items:center;gap:8px}
.centerLine{height:2.5px;background:var(--wire);border-radius:2px;margin:10px auto;width:90%}
</style>
</head><body>
<header>
  <h1>ã‚¹ãƒãƒ›ç”¨ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ„ãƒªãƒ¼</h1>
  <div class="sub">äººç‰©ã‚’è¿½åŠ  â†’ ãƒ„ãƒªãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã€‚?shared=1 ã§å…±æœ‰è¡¨ç¤ºï¼ˆé–²è¦§å°‚ç”¨ï¼‰ã€‚</div>
</header>

<div class="wrap">
  <div class="tabs">
    <div class="tab active" id="tabTree">ãƒ„ãƒªãƒ¼</div>
    <div class="tab" id="tabForm">äººç‰©ã‚’è¿½åŠ  / ç·¨é›†</div>
    <div class="tab" id="tabData">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
  </div>

  <section class="card" id="viewTree">
    <div class="btnbar"><button class="btn ghost" id="btnScrollTop">å…ˆé ­ã¸</button></div>
    <div class="tree" id="tree"></div>
  </section>

  <section class="card" id="viewForm" style="display:none">
    <div class="hint">IDã¨åå‰ã¯å¿…é ˆã€‚ä¿å­˜ã§ãƒ„ãƒªãƒ¼æ›´æ–°ã€‚</div>
    <div class="row"><label>IDï¼ˆè‹±æ•°å­—ãƒ»ä¸€æ„ï¼‰</label><input id="f_id" placeholder="ä¾‹: daisuke"></div>
    <div class="row"><label>åå‰</label><input id="f_name" placeholder="ä¾‹: å°æ— å¤§è³‡"></div>
    <div class="row"><label>ãƒ•ãƒªã‚¬ãƒŠ</label><input id="f_furi" placeholder="ä¾‹: ã‚³ãƒãƒ¤ã‚· ãƒ€ã‚¤ã‚¹ã‚±"></div>
    <div class="row"><label>ç”Ÿå¹´æœˆæ—¥</label><input id="f_birth" type="date"></div>
    <div class="row"><label>å¥½ããªã“ã¨ï¼ˆ, åŒºåˆ‡ã‚Šï¼‰</label><input id="f_likes"></div>
    <div class="row"><label>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ï¼ˆ, åŒºåˆ‡ã‚Šï¼‰</label><input id="f_allergies"></div>
    <div class="row"><label>å°†æ¥ã®æŠ±è²  / ä¸€è¨€</label><input id="f_goals"></div>
    <div class="row"><label>ãƒ¡ãƒ¢</label><textarea id="f_notes"></textarea></div>
    <div class="row"><label>ãƒªãƒ³ã‚¯1ãƒ©ãƒ™ãƒ«/URL</label><input id="f_link1_label" placeholder="LINE / å†™çœŸ"><input id="f_link1_url" placeholder="https://..."></div>
    <div class="row"><label>ãƒªãƒ³ã‚¯2ãƒ©ãƒ™ãƒ«/URL</label><input id="f_link2_label" placeholder="ä»»æ„"><input id="f_link2_url" placeholder="https://..."></div>
    <div class="row"><label>è¦ªï¼ˆ1äººç›®ï¼‰</label><select id="f_parent1"></select></div>
    <div class="row"><label>è¦ªï¼ˆ2äººç›®ãƒ»ä»»æ„ï¼‰</label><select id="f_parent2"></select></div>
    <div class="row"><label>ã‚¿ã‚°ï¼ˆ, åŒºåˆ‡ã‚Šï¼‰</label><input id="f_tags"></div>
    <div class="btnbar">
      <button class="btn" id="btnSave">ä¿å­˜ã™ã‚‹</button>
      <button class="btn ghost" id="btnNew">æ–°è¦ã«ã™ã‚‹</button>
      <button class="btn danger" id="btnDelete">ã“ã®äººç‰©ã‚’å‰Šé™¤</button>
    </div>
  </section>

  <section class="card" id="viewData" style="display:none">
    <div class="btnbar">
      <button class="btn alt" id="btnExport">JSONã‚’æ›¸ãå‡ºã™</button>
      <label class="btn ghost" for="fileImport">JSONã‚’èª­ã¿è¾¼ã‚€</label>
      <input id="fileImport" type="file" accept="application/json" style="display:none">
      <button class="btn danger" id="btnReset">åˆæœŸãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™</button>
    </div>
    <div class="hint">å…±æœ‰è¡¨ç¤ºã¯ã€URLæœ«å°¾ã« <b>?shared=1</b> ã‚’ä»˜ã‘ã‚‹ã€‚<br>åŒã˜å ´æ‰€ã® <code>family_data.json</code> ã‚’èª­ã¿è¾¼ã‚“ã§é–²è¦§å°‚ç”¨ã«ãªã‚Šã¾ã™ã€‚</div>
  </section>
</div>

<dialog id="card">
  <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--line)">
    <div style="display:flex;gap:8px;align-items:center"><span class="pill">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span><strong id="c_name"></strong><span class="chip" id="c_furi"></span></div>
    <button class="btn ghost" id="c_close">é–‰ã˜ã‚‹</button>
  </div>
  <div style="padding:12px">
    <div class="row"><label>ã€åå‰ã€‘</label><div id="v_name"></div></div>
    <div class="row"><label>ã€ãƒ•ãƒªã‚¬ãƒŠã€‘</label><div id="v_furigana"></div></div>
    <div class="row"><label>ã€ç”Ÿå¹´æœˆæ—¥ ğŸ‚ã€‘</label><div id="v_birth"></div></div>
    <div class="row"><label>ã€ç¾åœ¨ã®å¹´é½¢ ğŸ‰ã€‘</label><div id="v_age"></div></div>
    <div class="row"><label>ã€å…„å¼Ÿãƒ»å§‰å¦¹ã€‘</label><div id="v_siblings"></div></div>
    <div class="row"><label>ã€ãƒ‘ãƒ‘ãƒ»ãƒãƒã€‘</label><div id="v_parents"></div></div>
    <div class="row"><label>ã€å¥½ããªã“ã¨ ğŸ§¡ã€‘</label><div id="v_likes"></div></div>
    <div class="row"><label>ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ ğŸ¤§ã€‘</label><div id="v_allergies"></div></div>
    <div class="row"><label>ã€å°†æ¥ã®æŠ±è²  ğŸ€ã€‘</label><div id="v_goals"></div></div>
    <div class="row"><label>ã€ãã®ä»–ã€‘</label><div id="v_notes"></div></div>
    <div class="row"><label>ğŸ”— ãƒªãƒ³ã‚¯</label><div id="v_links" class="children"></div></div>
    <div class="row"><label>ã‚¿ã‚°</label><div id="v_tags" class="children"></div></div>
    <div class="btnbar"><button class="btn" id="btnEditFromCard">ã“ã®äººã‚’ç·¨é›†ã™ã‚‹</button><span class="mono">ID: <span id="v_id"></span></span></div>
  </div>
</dialog>

<script>
// ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
const LSKEY="familyDataV1";
const q=id=>document.getElementById(id);
function saveLocal(arr){ try{ localStorage.setItem(LSKEY, JSON.stringify(arr)); }catch(e){} }
function loadLocal(){ try{ const raw=localStorage.getItem(LSKEY); if(!raw) return null; const arr=JSON.parse(raw); return Array.isArray(arr)?arr:null; }catch(e){return null;} }
function byId(arr){ return Object.fromEntries((arr||[]).filter(p=>p&&p.id).map(p=>[p.id,p])); }
function fmtDate(s){ if(!s) return ""; const d=new Date(s); if(isNaN(d)) return s; const y=d.getFullYear(),m=("0"+(d.getMonth()+1)).slice(-2),dd=("0"+d.getDate()).slice(-2); return `${y}/${m}/${dd}`; }
function ageStr(b){ if(!b) return ""; const T=new Date(); const d=new Date(b); if(isNaN(d)) return ""; let y=T.getFullYear()-d.getFullYear(); const before=(T.getMonth()<d.getMonth())||(T.getMonth()==d.getMonth()&&T.getDate()<d.getDate()); if(before) y--; const days=Math.floor((T-d)/86400000); return `${y}æ­³ï¼ˆç”Ÿå¾Œ${days}æ—¥ï¼‰`; }

// å…±æœ‰èª­è¾¼ï¼ˆ?shared=1 / ?src=URLï¼‰
const MODE={readOnly:false,source:"local"};
function getParam(name){ const u=new URL(location.href); return u.searchParams.get(name); }
async function tryLoadRemote(){
  const srcParam=getParam('src'); const shared=getParam('shared');
  const src=srcParam || (shared ? 'family_data.json' : '');
  if(!src) return false;
  try{
    const res=await fetch(src,{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status);
    const arr=await res.json();
    if(Array.isArray(arr)){ data=arr; MODE.readOnly=true; MODE.source=srcParam?'url':'same-folder'; return true; }
    else throw new Error('JSONã®å½¢å¼ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
  }catch(e){ alert('å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š'+(e?.message||e)); return false; }
}
function applyReadOnlyUI(){
  if(!MODE.readOnly) return;
  const note=document.createElement('div');
  note.className='viewonly'; note.textContent='ã“ã‚Œã¯å…±æœ‰ãƒ“ãƒ¥ãƒ¼ã§ã™ï¼ˆé–²è¦§å°‚ç”¨ï¼‰ã€‚ç·¨é›†ã¯å„è‡ªã®ç«¯æœ«ã§è¡Œã£ã¦ãã ã•ã„ã€‚';
  q('viewTree').prepend(note);
  q('tabForm').style.display='none';
  q('tabData').style.display='none';
}

// ===== åˆæœŸãƒ‡ãƒ¼ã‚¿ =====
const initial=[{"id":"daisuke","name":"å°æ— å¤§è³‡","furigana":"ã‚³ãƒãƒ¤ã‚· ãƒ€ã‚¤ã‚¹ã‚±","birth":"1998-08-12","likes":["å¤ã®å¤œ","BUMP OF CHICKEN","è€ƒãˆäº‹","çµµã‚’æãã“ã¨"],"allergies":["çŠ¬","ãƒãƒ§ã‚³","æ¢…å¹²ã—","ç´è±†"],"notes":"ä¼¼é¡”çµµæã‘ã¾ã™ / AIå‹‰å¼·ä¸­","links":[{"label":"LINE","url":"https://line.me/R/ti/p/xxxxxxxx"}],"parents":["toru","tomoko"],"tags":["198ç³»"]},{"id":"toru","name":"å°æ— å¾¹","furigana":"ã‚³ãƒãƒ¤ã‚· ãƒˆã‚ªãƒ«","tags":["çˆ¶"]},{"id":"tomoko","name":"å°æ— çŸ¥å­","furigana":"ã‚³ãƒãƒ¤ã‚· ãƒˆãƒ¢ã‚³","tags":["æ¯"]},{"id":"yuta","name":"å°æ— å„ªå¤ª","furigana":"ã‚³ãƒãƒ¤ã‚· ãƒ¦ã‚¦ã‚¿","tags":["ãƒ‘ãƒ‘"]},{"id":"mai","name":"èˆ","furigana":"ãƒã‚¤","tags":["ãƒãƒ"]},{"id":"sonoka","name":"æƒ³æœ","furigana":"ã‚½ãƒã‚«","birth":"2020-09-16","parents":["yuta","mai"],"tags":["é•·å¥³"]},{"id":"yume","name":"å¤¢ä¹ƒ","furigana":"ãƒ¦ãƒ¡ãƒ","birth":"2023-08-15","parents":["yuta","mai"],"tags":["æ¬¡å¥³"]},{"id":"ritto","name":"å°æ— å¾‹ç¿”","furigana":"ã“ã°ã‚„ã— ã‚Šã¤ã¨","birth":"2025-08-04","likes":["å¯ã‚‹ã“ã¨ğŸ’¤"],"allergies":["ç”Ÿç‰©","ãŠè‚‰","ãƒãƒãƒŸãƒ„"],"goals":"è‡ªç¿’é¤¨ã«ãŠå—é¨“ã™ã‚‹ã“ã¨","parents":["yuta","mai"],"tags":["é•·ç”·"]}];

// ===== çŠ¶æ…‹ï¼†ã‚¿ãƒ– =====
let data=loadLocal()||initial.slice();
let editingId="";
const tabTree=q('tabTree'), tabForm=q('tabForm'), tabData=q('tabData');
const viewTree=q('viewTree'), viewForm=q('viewForm'), viewData=q('viewData');
function setTab(which){
  [tabTree,tabForm,tabData].forEach(t=>t.classList.remove('active'));
  [viewTree,viewForm,viewData].forEach(v=>v.style.display='none');
  if(which==='tree'){ tabTree.classList.add('active'); viewTree.style.display='block'; }
  if(which==='form'){ tabForm.classList.add('active'); viewForm.style.display='block'; }
  if(which==='data'){ tabData.classList.add('active'); viewData.style.display='block'; }
  scrollTo({top:0,behavior:'smooth'});
}
tabTree.onclick=()=>setTab('tree');
tabForm.onclick=()=>{ refreshParents(); setTab('form'); };
tabData.onclick=()=>setTab('data');
q('btnScrollTop').onclick=()=>scrollTo({top:0,behavior:'smooth'});

// ===== ãƒ•ã‚©ãƒ¼ãƒ  =====
const f={ id:q('f_id'), name:q('f_name'), furi:q('f_furi'), birth:q('f_birth'),
  likes:q('f_likes'), allergies:q('f_allergies'), goals:q('f_goals'), notes:q('f_notes'),
  link1_label:q('f_link1_label'), link1_url:q('f_link1_url'),
  link2_label:q('f_link2_label'), link2_url:q('f_link2_url'),
  p1:q('f_parent1'), p2:q('f_parent2'), tags:q('f_tags')
};
function refreshParents(){
  [f.p1,f.p2].forEach(sel=>sel.innerHTML='');
  const opt=(v,t)=>{const o=document.createElement('option');o.value=v;o.textContent=t;return o;};
  const byName=data.slice().sort((a,b)=>(a.name||'').localeCompare(b.name||'ja'));
  [f.p1,f.p2].forEach(sel=>sel.appendChild(opt('','ï¼ˆæŒ‡å®šã—ãªã„ï¼‰')));
  byName.forEach(p=>[f.p1,f.p2].forEach(sel=>sel.appendChild(opt(p.id,`${p.name}ï¼ˆ${p.id}ï¼‰`))));
}
function fillForm(p){
  editingId=p.id||"";
  const toCSV=a=>Array.isArray(a)?a.join(", "):(a||"");
  f.id.value=p.id||""; f.name.value=p.name||""; f.furi.value=p.furigana||"";
  f.birth.value=p.birth||""; f.likes.value=toCSV(p.likes); f.allergies.value=toCSV(p.allergies);
  f.goals.value=p.goals||""; f.notes.value=p.notes||"";
  f.link1_label.value=p.links?.[0]?.label||""; f.link1_url.value=p.links?.[0]?.url||"";
  f.link2_label.value=p.links?.[1]?.label||""; f.link2_url.value=p.links?.[1]?.url||"";
  refreshParents(); f.p1.value=p.parents?.[0]||""; f.p2.value=p.parents?.[1]||"";
  f.tags.value=toCSV(p.tags);
}
function formToObj(){
  const split=s=>s?s.split(",").map(s=>s.trim()).filter(Boolean):[];
  const links=[]; if(f.link1_label.value||f.link1_url.value) links.push({label:f.link1_label.value,url:f.link1_url.value});
  if(f.link2_label.value||f.link2_url.value) links.push({label:f.link2_label.value,url:f.link2_url.value});
  const parents=[f.p1.value,f.p2.value].filter(Boolean);
  return { id:f.id.value.trim(), name:f.name.value.trim(), furigana:f.furi.value.trim(), birth:f.birth.value||undefined,
    likes:split(f.likes.value), allergies:split(f.allergies.value), goals:f.goals.value.trim(), notes:f.notes.value,
    links, parents, tags:split(f.tags.value) };
}
q('btnSave').onclick=()=>{
  const obj=formToObj(); if(!obj.id){alert('IDã¯å¿…é ˆã§ã™');return;} if(!obj.name){alert('åå‰ã¯å¿…é ˆã§ã™');return;}
  const oldId=editingId||""; const newId=obj.id;
  const idxOld=data.findIndex(p=>p.id===oldId); const isRename=oldId&&oldId!==newId&&idxOld>=0;
  if(isRename){
    data.splice(idxOld,1); data.push(obj);
    // å‚ç…§ç½®æ›
    data.forEach(p=>{ if(Array.isArray(p.parents)) p.parents=p.parents.map(pid=>pid===oldId?newId:pid); });
  }else{
    const idx=data.findIndex(p=>p.id===newId); if(idx>=0) data[idx]=obj; else data.push(obj);
  }
  saveLocal(data); buildTree(); alert('ä¿å­˜ã—ã¾ã—ãŸï¼'); setTab('tree'); editingId=newId;
};
q('btnNew').onclick=()=>{editingId=""; fillForm({});};
q('btnDelete').onclick=()=>{
  const id=f.id.value.trim(); if(!id){alert('å‰Šé™¤ã™ã‚‹IDãŒæœªå…¥åŠ›ã§ã™');return;}
  if(!confirm(`IDã€Œ${id}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  data=data.filter(p=>p.id!==id); saveLocal(data); buildTree(); alert('å‰Šé™¤ã—ã¾ã—ãŸ'); fillForm({}); setTab('tree');
};

// ===== è¦ªãƒ¦ãƒ‹ãƒƒãƒˆæ§‹ç¯‰ï¼ˆå¤«å©¦ or ç‰‡è¦ªï¼‰ï¼†æç”» =====
const drawnPeople=new Set();   // æã„ãŸå€‹äººID
const drawnUnits =new Set();   // æã„ãŸãƒ¦ãƒ‹ãƒƒãƒˆã‚­ãƒ¼

// ãƒ¦ãƒ‹ãƒƒãƒˆã‚­ãƒ¼ç”Ÿæˆï¼šè¦ª2äººãªã‚‰ "a|b"ï¼ˆIDã‚½ãƒ¼ãƒˆæ¸ˆã¿ï¼‰ï¼ç‰‡è¦ªãªã‚‰ "a|-"
function unitKeyFromParents(parents){
  const ps=(parents||[]).filter(Boolean);
  if(ps.length>=2){ const pair=ps.slice(0,2).sort(); return pair[0]+'|'+pair[1]; }
  if(ps.length===1){ return ps[0]+'|-'; }
  return null;
}

function wireDown(){ const v=document.createElement('div'); v.className='linkDown'; return v; }

function personBox(p){
  const box=document.createElement('div'); box.className='node person';
  box.innerHTML=`<span class="pill">${p.furigana||'â€”'}</span><span class="n">${p.name||'(ç„¡å)'}</span>${p.birth?`<span class="chip">${fmtDate(p.birth)}</span>`:(p.tags?.[0]?`<span class="chip">${p.tags[0]}</span>`:"")}`;
  box.onclick=()=>openCard(p); return box;
}
function renderPerson(id){
  if(drawnPeople.has(id)) return document.createElement('span');
  const p=byId(data)[id]; const g=document.createElement('div'); g.className='g';
  g.appendChild(personBox(p)); drawnPeople.add(id); return g;
}

function renderUnit(key, maps){
  if(drawnUnits.has(key)) return document.createElement('span');
  drawnUnits.add(key);

  const {people, unitKids, personToUnit} = maps;
  const g=document.createElement('div'); g.className='g';
  const box=document.createElement('div'); box.className='node unit';

  const [aId,bId]=key.split('|'); // bId ã¯ "âˆ’" ã®å ´åˆã‚ã‚Šï¼ˆç‰‡è¦ªï¼‰
  const A=people[aId]; const B=bId==='-'?null:people[bId];

  const left=document.createElement('div'); left.className='sp';
  left.innerHTML=`<span class="pill">${A?.furigana||'â€”'}</span><span class="n">${A?.name||'(ç„¡å)'}</span>`;
  left.setAttribute('role','button'); left.onclick=(ev)=>{ev.stopPropagation(); openCard(A);};
  box.appendChild(left);

  const mid=document.createElement('div'); mid.className='sep'; box.appendChild(mid);

  if(B){ // å¤«å©¦
    const right=document.createElement('div'); right.className='sp';
    right.innerHTML=`<span class="pill">${B.furigana||'â€”'}</span><span class="n">${B.name||'(ç„¡å)'}</span>`;
    right.setAttribute('role','button'); right.onclick=(ev)=>{ev.stopPropagation(); openCard(B);};
    box.appendChild(right);
  }else{ // ç‰‡è¦ªè¡¨ç¤ºï¼ˆå³å´ã¯ãƒ€ãƒŸãƒ¼ï¼‰
    const right=document.createElement('div'); right.className='sp'; right.style.opacity=.25;
    right.innerHTML=`<span class="pill">ï¼ˆç‰‡è¦ªï¼‰</span><span class="n">â€”</span>`;
    box.appendChild(right);
  }

  g.appendChild(box);

  const kids=(unitKids[key]||[]).slice().sort((x,y)=>{
    const bx=people[x]?.birth?new Date(people[x].birth).getTime():Infinity;
    const by=people[y]?.birth?new Date(people[y].birth).getTime():Infinity; return bx-by;
  });

  if(kids.length){
    g.appendChild(wireDown());
    const row=document.createElement('div'); row.className='children';
    kids.forEach(cid=>{
      const wrap=document.createElement('div'); wrap.className='childWrap';
      const ck=personToUnit[cid];
      if(ck && ck!==key && !drawnUnits.has(ck)){ wrap.appendChild(renderUnit(ck, maps)); }
      else{ if(!drawnPeople.has(cid)) wrap.appendChild(renderPerson(cid)); }
      row.appendChild(wrap);
    });
    g.appendChild(row);
  }
  return g;
}

function buildTree(){
  // æ¯å›ãƒªã‚»ãƒƒãƒˆï¼ˆconstã®ã¾ã¾ .clear()ï¼‰
  drawnPeople.clear(); drawnUnits.clear();

  const people = byId(data);

  // 1) å­â†’è¦ªã‹ã‚‰ãƒ¦ãƒ‹ãƒƒãƒˆé›†åˆã¨å­ãƒªã‚¹ãƒˆã‚’ä½œæˆ
  const unitKids={};                  // key -> [childIds]
  const personToUnit={};              // parentId -> unitKeyï¼ˆãã®äººãŒå±ã™ã‚‹è¦ªãƒ¦ãƒ‹ãƒƒãƒˆï¼‰
  const isChild=new Set();            // è¦ªã‚’æŒã¤äºº
  const inAnyUnit=new Set();          // è¦ªã¨ã—ã¦ãƒ¦ãƒ‹ãƒƒãƒˆã«å‚åŠ ã—ã¦ã„ã‚‹äºº

  data.forEach(p=>{
    const key=unitKeyFromParents(p.parents);
    if(key){ // ã“ã®äººã¯å­ã¨ã—ã¦ãƒ¦ãƒ‹ãƒƒãƒˆ key ã«ã¶ã‚‰ä¸‹ãŒã‚‹
      (unitKids[key] ||= []).push(p.id);
      isChild.add(p.id);
      // è¦ªå´ã‚’ãƒ¦ãƒ‹ãƒƒãƒˆã«ç™»éŒ²
      const [a,b]=key.split('|');
      if(a && a!=='-'){ personToUnit[a]=personToUnit[a]||key; inAnyUnit.add(a); }
      if(b && b!=='-'){ personToUnit[b]=personToUnit[b]||key; inAnyUnit.add(b); }
    }
  });

  // 2) ãƒ«ãƒ¼ãƒˆæ±ºå®š
  //   ãƒ«ãƒ¼ãƒˆè¦ªãƒ¦ãƒ‹ãƒƒãƒˆï¼šè¦ª2äººï¼ˆã¾ãŸã¯ç‰‡è¦ªï¼‰ã©ã¡ã‚‰ã‚‚ã€Œå­ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã€
  const rootUnits=[];
  Object.keys(unitKids).forEach(key=>{
    const [a,b]=key.split('|');
    const aIsRoot = !isChild.has(a);
    const bIsRoot = (b==='-') ? true : !isChild.has(b);
    if(aIsRoot && bIsRoot) rootUnits.push(key);
  });

  //   ãƒ«ãƒ¼ãƒˆå˜ç‹¬ï¼šè¦ªã‚’æŒãŸãšã€ã‹ã¤è¦ªãƒ¦ãƒ‹ãƒƒãƒˆã«ã‚‚å…¥ã£ã¦ã„ãªã„äºº
  const rootSingles=data.filter(p=>{
    const noParents=!(p.parents&&p.parents.length);
    return noParents && !inAnyUnit.has(p.id);
  }).map(p=>p.id);

  // 3) æç”»
  const tree=q('tree'); tree.innerHTML="";
  const row=document.createElement('div'); row.className='children'; row.style.marginTop='12px';
  const wrap=document.createElement('div'); wrap.className='childWrap';

  rootUnits.forEach(k=>{
    const w=document.createElement('div'); w.className='childWrap';
    w.appendChild(renderUnit(k,{people,unitKids,personToUnit}));
    wrap.appendChild(w);
  });
  rootSingles.forEach(id=>{
    const w=document.createElement('div'); w.className='childWrap';
    w.appendChild(renderPerson(id));
    wrap.appendChild(w);
  });

  row.appendChild(wrap);
  tree.appendChild(row);
  refreshParents();
}

// ===== ã‚«ãƒ¼ãƒ‰ =====
const dlg=q('card'); q('c_close').onclick=()=>dlg.close();
q('btnEditFromCard').onclick=()=>{ const id=q('v_id').textContent; const p=data.find(x=>x.id===id); if(p){ fillForm(p); setTab('form'); dlg.close(); } };
function openCard(p){
  const T=(id,v)=>q(id).textContent=v||"";
  T('c_name',p.name); T('c_furi',p.furigana); T('v_id',p.id);
  T('v_name',p.name); T('v_furigana',p.furigana);
  T('v_birth',p.birth?fmtDate(p.birth):""); T('v_age',p.birth?ageStr(p.birth):"");
  const names=(p.parents||[]).map(pid=> (data.find(x=>x.id===pid)||{}).name).filter(Boolean);
  T('v_parents',names.join("ãƒ»"));
const myParents = new Set((p.parents||[]).filter(Boolean));
let sib = [];
if (myParents.size > 0) {
  sib = data.filter(x=>{
    if (x.id === p.id) return false;                 // è‡ªåˆ†ã¯é™¤å¤–
    const xp = new Set((x.parents||[]).filter(Boolean));
    if (xp.size === 0) return false;                 // è¦ªãªã—ã¯å…„å¼Ÿã«ã—ãªã„
    // è¦ªã®ã©ã‚Œã‹ãŒä¸€è‡´ã™ã‚Œã°å…„å¼Ÿæ‰±ã„ï¼ˆç‰‡è¦ªOKï¼‰
    let share = false;
    for (const id of xp) if (myParents.has(id)) { share = true; break; }
    // è‡ªåˆ†ã®è¦ªãã®ã‚‚ã®ã¯å…„å¼Ÿã«ã—ãªã„
    const isMyParent = myParents.has(x.id);
    return share && !isMyParent;
  }).sort((a,b)=>{
    const ta = a.birth ? new Date(a.birth).getTime() : Infinity;
    const tb = b.birth ? new Date(b.birth).getTime() : Infinity;
    return ta - tb;
  }).map(x=>x.name + (x.birth?`ï¼ˆ${fmtDate(x.birth)}ï¼‰`:""));
}
  T('v_siblings',sib.join("ã€"));
  const likes=Array.isArray(p.likes)?p.likes.join("ã€"):(p.likes||"");
  const allergies=Array.isArray(p.allergies)?p.allergies.join("ã€"):(p.allergies||"");
  T('v_likes',likes); T('v_allergies',allergies);
  T('v_goals',p.goals||""); T('v_notes',p.notes||"");
  const lw=q('v_links'); lw.innerHTML="";
  (p.links||[]).forEach(l=>{ if(!l?.url) return; const a=document.createElement('a'); a.href=l.url; a.target="_blank"; a.rel="noopener"; a.className='chip'; a.textContent=l.label||"ãƒªãƒ³ã‚¯"; lw.appendChild(a); });
  const tw=q('v_tags'); tw.innerHTML=""; (p.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=t; tw.appendChild(s); });
  dlg.showModal();
}

// ===== Export / Import / Reset =====
q('btnExport').onclick=async()=>{
  try{
    const json=JSON.stringify(data,null,2);
    const blob=new Blob([json],{type:"application/json"});
    const fileName="family_data.json";
    const shareFile=new File([blob],fileName,{type:"application/json"});
    const canShare=!!(navigator.canShare && navigator.canShare({files:[shareFile]}));
    if(canShare && navigator.share){
      await navigator.share({files:[shareFile],title:"Family data",text:"ã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€ã‚’é¸ã‚“ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"});
      alert("å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã¾ã—ãŸã€‚ã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€ã§ä¿å­˜å…ˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
    }else{
      const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=fileName; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ã€ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒªã®â€œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰â€ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚");
    }
  }catch(e){ alert("æ›¸ãå‡ºã—ã‚¨ãƒ©ãƒ¼: "+(e?.message||e)); }
};
q('fileImport').onchange=(ev)=>{
  const f=ev.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{ const arr=JSON.parse(reader.result); if(!Array.isArray(arr)) throw new Error("é…åˆ—ãƒ‡ãƒ¼ã‚¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
      data=arr; saveLocal(data); buildTree(); alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
    }catch(err){ alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: "+err.message); }
  };
  reader.readAsText(f);
};
q('btnReset').onclick=()=>{ if(!confirm("åˆæœŸãƒ‡ãƒ¼ã‚¿ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆç«¯æœ«ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã™ï¼‰")) return; data=initial.slice(); saveLocal(data); buildTree(); alert("åˆæœŸåŒ–ã—ã¾ã—ãŸ"); };

// ===== Boot =====
(async()=>{
  try{ await tryLoadRemote(); }catch(e){ alert('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: '+(e?.message||e)); }
  try{ buildTree(); }catch(e){ alert('æç”»ã‚¨ãƒ©ãƒ¼: '+(e?.message||e)); q('tree').innerHTML=''; }
  refreshParents(); applyReadOnlyUI();
})();
</script>
</body></html>
